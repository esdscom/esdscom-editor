@using Syncfusion.Blazor
@using Syncfusion.Blazor.Grids

@inject NavigationManager nav
@inject HttpClient api

<div class="row">
    <div class="col-2">    
        <OccursComponent OccursText= "@occurs"/>
        <button type="button" class="btn btn-link" @onclick="ToggleHelp">@displayname</button>
    </div>
    <div class="col-10">
        <button type="button" class="btn btn-primary" @onclick="SetEditMode">Edit</button>
    </div>
</div>

<div hidden="@bHideHelp">   
     <div class="row">
        <div class="col">
             <DataPointCommentsComponent Comments="@comments" Occurs="@occurs" XPath="@xPath" />
        </div>
    </div>   
</div>

<div class="row m-2">
    <div class="col">
        @selected
    </div>
</div>

<div class="row"  hidden="@(!bEditMode)">
    <div class="col">
        <button type="button" class="btn btn-primary" @onclick="SavePhrases">Save</button>
    </div>
</div>

<div class="row" hidden="@(!bEditMode)">
       
    <div class="col">
    <SfGrid @ref="@Grid" DataSource="@phraseList" EnableVirtualization="true" AllowPaging="true" AllowSorting="true"
            AllowFiltering="true" AllowTextWrap="true" AllowSelection="true" RowHeight="30">
        <GridPageSettings PageSize="10" />
        <GridEvents RowSelected="RowSelection" TValue="Phrase" RowDeselected="RowDeselection" />
        <GridSelectionSettings Type="@GetSelectionType()" PersistSelection="true"></GridSelectionSettings>
        <GridColumns>
            @if (showCheckboxes)
            {
                <GridColumn Type="ColumnType.CheckBox" AllowFiltering="false" AllowSorting="false" Width="60"></GridColumn>
            }
            <GridColumn Field=@nameof(Phrase.StrucCode) HeaderText="Structure Code" Width="100"></GridColumn>
            <GridColumn Field=@nameof(Phrase.Region) HeaderText="Region" Width="100"></GridColumn>
            <GridColumn Field=@nameof(Phrase.English) HeaderText="English" TextAlign="TextAlign.Left" Width="450"></GridColumn>
        </GridColumns>
    </SfGrid>
    </div>
</div>

@code
{
    [CascadingParameter] public AppState AppState { get; set; }

    [Parameter] public XmlNode Node { get; set; }

    [Parameter] public BaseEntity Entity { get; set; }

    [Parameter] public EventCallback<List<Phrase>> OnPhrasesSaved { get; set; }

    [Parameter] public EventCallback OnCancel { get; set; }

    SfGrid<Phrase> Grid;

    List<Phrase> phraseList;
    List<Phrase> selectedPhraseList = new();

    bool CorePhrases = true;
    bool ESPhrases = true;
    int phraseCount { get; set; } = 10;
    bool showCheckboxes = true;

    string comments;
    string occurs;
    string displayname;
    bool bHideHelp;
    bool bEditMode;
    string xPath;

    string selected { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        displayname = Entity.DisplayName;

        xPath = XmlUtils.GetFullXPath(Node);

        SetPhraseList(xPath);

        if (Entity is not null)
        {
            displayname = Entity.DisplayName;
            comments = $"{Entity.Comments} {Entity.TypeComments}";
            occurs = Utils.GetOccursText(Entity.Occurs);
        }
        else
        {
            displayname = "entity Not found!!!";
        }

        bHideHelp = true;
    }

    SelectionType GetSelectionType()
    {
        if (Entity.Occurs == Enums.DataPointOccurence.OptionalZeroOrOne || Entity.Occurs == Enums.DataPointOccurence.RequiredExactlyOnce)
        {
            showCheckboxes = false;
            return SelectionType.Single;
        }
        else
        {
            showCheckboxes = true;
            return SelectionType.Multiple;
        }
    }

    public void RowSelection(RowSelectEventArgs<Phrase> args)
    {
        selectedPhraseList.Add(args.Data);
        DisplaySelectedPhrases();
        StateHasChanged();
    }

    public void RowDeselection(RowDeselectEventArgs<Phrase> args)
    {
        selectedPhraseList.Remove(args.Data);
        DisplaySelectedPhrases();
        StateHasChanged();
    }


    void SetEditMode()
    {
        bEditMode = !bEditMode;
    }

    string DisplaySelectedPhrases()
    {
        selected = string.Empty;

        foreach (Phrase phrase in selectedPhraseList)
        {
            selected += phrase.English + ", ";
        }

        return selected;
    }

    void SetPhraseList(string xPath)
    {
        if (!string.IsNullOrEmpty(xPath))
        {
            phraseList = AppState.Phrases.Where(p => p.XPath == xPath).ToList();
        }
        else
        {
            Console.WriteLine($"No XPATH!: {Entity.DisplayName}");
        }
    }
   
    async Task SavePhrases()
    {
        await OnPhrasesSaved.InvokeAsync(selectedPhraseList);
    }

    async Task Close()
    {
        await OnCancel.InvokeAsync();
    }

    void ToggleHelp()
    {
        bHideHelp = !bHideHelp;
    }
}
