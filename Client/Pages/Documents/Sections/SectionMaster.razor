@page "/Documents/Sections/SectionMaster/{NodeName}"

@inject NavigationManager nav
@inject HttpClient api

<EditForm EditContext="CurrentEditContext" OnValidSubmit="SaveAsync">

        <ComplexTypeComponent Node="@activeNode" Entity="@entity" />

        <button type="submit" class="btn btn-primary">Save</button>

</EditForm>

@code
{
    [CascadingParameter] public AppState AppState { get; set; }

    [Parameter] public string NodeName { get; set; }
    [Parameter] public string EntityType { get; set; }

    public EditContext CurrentEditContext { get; set; }

    private XmlNode activeNode;
    private BaseEntity entity;

    protected override void OnInitialized()
    {
        base.OnInitialized();

        activeNode = AppState.ActiveDatasheet.DatasheetXDoc.DocumentElement.SelectSingleNode(NodeName);

        entity = AppState.SchemaElements.Where(s => s.NodeName == activeNode.Name).FirstOrDefault();

        CurrentEditContext = new EditContext(activeNode);
    }

    private async Task SaveAsync()
    {
        AppDataService dMgr = new(api);

        AppState.ActiveDatasheet = await dMgr.UpdateDatasheetAsync(AppState.ActiveDatasheet);

        AppState.StatusBarMessage = "Document Saved";

        nav.NavigateTo("/Documents/Sections/SectionHome");
    }
}
